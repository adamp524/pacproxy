#!/usr/bin/env ruby

require 'pacproxy'
require 'optparse'
require 'logger'

port = 3128
proxy_pac = nil
daemonize = false
log_file = 'pacproxy.log'

OptionParser.new do |o|
  o.on('-d', 'daemonize') { daemonize = true }
  o.on('-l LOGFILE', String, "specify log file. default: #{log_file}") { |l| log_file = l }
  o.on('-p PORT', Integer,"specify listening port. default: #{port}") { |p| port = p }
  o.on('-P PROXYPAC', String, 'specify proxy.pac location') { |pac| proxy_pac = pac }
  o.on('-h', 'show this help') { puts o; exit }
  o.parse!
end

logger = Logger.new(log_file, 'weekly')
logger.level = Logger::DEBUG

s = Pacproxy::Pacproxy.new(Port: port,
                           Proxypac: proxy_pac,
                           Logger: logger)

Signal.trap('INT') do
  s.shutdown
end

if daemonize
  WEBrick::Daemon.start { s.start }
else
  s.start
end
